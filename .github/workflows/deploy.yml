name: Deploy

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
      
# Authenticate to the the server via ssh 
# and run our deployment script 
jobs:
  deploy:
    runs-on: ubuntu-latest
    workflows: ["Build and Push Docker image"]   # <- espera o workflow "Build"
    steps:
      - uses: actions/checkout@v2
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          password: ${{ secrets.PASSWORD }}
          script: |
            APP_DIR="$HOME/book-app"

            if [ ! -d "$APP_DIR" ]; then
              echo "Clonando projeto..."
              git clone https://github.com/felipedeaguiar/book-app.git $APP_DIR
            fi

            cd $APP_DIR
            git pull origin master

            echo "Construindo imagens Docker..."
            docker-compose -f docker-compose.prod.yml pull
            docker-compose -f docker-compose.prod.yml up -d --build --remove-orphans
            
            echo "Recriando containers..."